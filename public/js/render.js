'use strict';

;
//
//	Utils
//
// * animate(cb, duraton) -- wrapper of requestAnimationFrame
//
// DOM manipulations
//
// * closePopup(event) -- close popup with users unique code
// * onVolumeBtnClick(event) -- handler for volume buttons clicks (mute/unmute trigger)
// * onVolumeSliderInput(event) -- change audio volume whenvolume slider is being moved
// * updateScore(number) -- update current score
//
//	Canvas
//
// * refreshComputedSizes(object) -- change <canvas> sizes to actual
// * addMovementOnCanvas(movementInfo) -- add new movement canvas-object
// * animateMovement(object) -- make recieved already added movement run (animate)
// * onAgSetupEvent(event) -- handler for event, fired when game settings are recieved
//
// To remove
//
// * start() -- start game
// * nextBeat(isFirst) -- process (and add) next movement
//
// Initialization
//

(function () {

	function animate(draw, duration) {
		var start = performance.now();

		requestAnimationFrame(function animate(time) {
			// определить, сколько прошло времени с начала анимации
			var timePassed = time - start;

			// возможно небольшое превышение времени, в этом случае зафиксировать конец
			if (timePassed > duration) timePassed = duration;

			// нарисовать состояние анимации в момент timePassed
			draw(timePassed);

			// если время анимации не закончилось - запланировать ещё кадр
			if (timePassed < duration) {
				requestAnimationFrame(animate);
			}
		});
	}

	var config = {
		colors: {
			neutral: '#FFA700', // #8D99AE #107E7D
			success: '#C2E812',
			fail: '#B80C09'
		},
		movements: {
			radiusPercent: 4,
			strokeWidthPercent: 0.5
		}
	};

	function closePopup(event) {
		document.querySelectorAll('.popup')[0].classList.add('closed');
		document.querySelectorAll('.logo')[0].classList.remove('with-popup');
	}

	// Mutes / unmutes audio
	function onVolumeBtnClick(event) {

		if (!config.currentAudio.muted) {

			// Change view
			this.childNodes[1].classList.remove('fa-volume-up');
			this.childNodes[1].classList.add('fa-volume-off');

			// Mute
			config.currentAudio.mute();
			config.currentAudio.muted = true;
		} else {

			// Change view
			this.childNodes[1].classList.remove('fa-volume-off');
			this.childNodes[1].classList.add('fa-volume-up');

			// Unmute
			config.currentAudio.unmute();
			config.currentAudio.muted = false;
		}
	}

	// Change volume level of current audio
	function onVolumeSliderInput(event) {
		config.currentAudio.volume(this.value / 100);
	}

	function updateScore(newScore) {

		var score = document.querySelectorAll('.score')[0];
		var scoreNumber = document.querySelectorAll('.score-number')[0];

		score.classList.add('update');
		setTimeout(function () {
			score.classList.remove('update');
		}, 400);

		config.currentScore = parseInt(newScore);
		scoreNumber.innerHTML = config.currentScore;

		return config.currentScore;
	}

	// **********
	// * CANVAS *
	// **********

	// Changes canvas background size when fired
	function refreshComputedSizes(object) {

		config.canvOpts.computedStyle = {
			width: +object.width.slice(0, -2),
			height: +object.height.slice(0, -2)
		};

		canvas.setDimensions({
			width: config.canvOpts.computedStyle.width,
			height: config.canvOpts.computedStyle.height
		});
	}

	function addMovementOnCanvas(movementInfo) {

		if (movementInfo.name == 'pass') return;

		var radius = config.canvOpts.movements.radius;
		var strokeWidth = config.canvOpts.movements.strokeWidth;
		// var x = Math.round(config.canvOpts.computedStyle.width - (config.canvOpts.computedStyle.width/100)*3) - radius*2;
		var x = Math.round(config.canvOpts.computedStyle.width);
		var y = Math.round(config.oneHPercent * 45) + config.canvOpts.movements.strokeWidth * 1.6;

		var circle = new fabric.Circle({
			fill: config.colors.neutral,
			stroke: '#FFFFFF',
			strokeWidth: strokeWidth,
			radius: radius,
			originY: 'center',
			originX: 'center'
		});

		// console.log(-circle.getRadiusX()*0.8);
		var arrow;

		switch (movementInfo.name) {
			case 'up':
				arrow = new fabric.Path('\n\t\t\t\tM ' + -circle.getRadiusX() * 0.65 + ' ' + circle.getRadiusY() * 0.11 + '\n\t\t\t\tL 0 ' + -circle.getRadiusY() * 0.55 + '\n\t\t\t\tL ' + circle.getRadiusX() * 0.65 + ' ' + circle.getRadiusY() * 0.11 + '\n\t\t\t\tL ' + circle.getRadiusX() * 0.5 + ' ' + circle.getRadiusY() * 0.25 + '\n\t\t\t\tL 0 ' + -circle.getRadiusY() * 0.25 + '\n\t\t\t\tL ' + -circle.getRadiusX() * 0.5 + ' ' + circle.getRadiusY() * 0.25 + '\n\t\t\t\tz', {
					// fill: '#fff',
					originY: 'center',
					originX: 'center'
				});
				break;

			case 'down':
				arrow = new fabric.Path('\n\t\t\t\tM ' + circle.getRadiusX() * 0.65 + ' ' + -circle.getRadiusY() * 0.11 + '\n\t\t\t\tL 0 ' + circle.getRadiusY() * 0.55 + '\n\t\t\t\tL ' + -circle.getRadiusX() * 0.65 + ' ' + -circle.getRadiusY() * 0.11 + '\n\t\t\t\tL ' + -circle.getRadiusX() * 0.5 + ' ' + -circle.getRadiusY() * 0.25 + '\n\t\t\t\tL 0 ' + circle.getRadiusY() * 0.25 + '\n\t\t\t\tL ' + circle.getRadiusX() * 0.5 + ' ' + -circle.getRadiusY() * 0.25 + '\n\t\t\t\tz', {
					// fill: '#fff',
					originY: 'center',
					originX: 'center'
				});
				break;
		}

		var movement = new fabric.Group([circle, arrow], {
			top: y,
			left: x
		});

		movementInfo.canvasObject = movement;

		canvas.add(movement);
		canvas.renderAll();
		// movementInfo.state = 'added';
	}

	function animateMovement(movementInfo) {

		// if (movementInfo.name == 'pass') return;

		movementInfo.canvasObject.animate('left', '' + (config.oneWPercent * 20 + config.canvOpts.movements.strokeWidth * 1.5), {
			onChange: canvas.renderAll.bind(canvas),
			duration: config.currentMinInterval
		});
	}

	function onGlSetupEvent(event) {
		config.currentBpm = event.detail.bpm;
		config.currentMinInterval = 60000 * 4 / config.currentBpm;
		config.currentSongName = event.detail.song;
		config.currentAudio = event.detail.music;
		closePopup();
		console.log(event.detail.bpm);

		// Test
		config.currentAudio.play();
	}

	// Actions performed when current game settings recieved
	function onGlAddMovement(event) {

		config.currentMovements.push({ name: event.detail });
		var thisMovement = config.currentMovements[config.currentMovements.length - 1];

		if (thisMovement.name == 'pass') return;

		addMovementOnCanvas(thisMovement);
		animateMovement(thisMovement);
	}

	function onGlStatus(event) {

		var status = event.detail.status;
		var movementIndex = event.detail.index;
		var newScore = event.detail.newScore;

		if (config.currentMovements[movementIndex].name == 'pass') return;

		var canvObj = config.currentMovements[movementIndex].canvasObject;

		// Run canvas animation
		canvObj.set({
			fill: config.colors[status]
		});

		// centeredScaling: true
		switch (status) {
			case 'success':
				canvObj.animate({
					'scaleX': 6,
					'scaleY': 6,
					'opacity': 0,
					'left': '-=' + config.canvOpts.movements.radius * 5.2,
					'top': '-=' + config.canvOpts.movements.radius * 5.2
				}, {
					onChange: canvas.renderAll.bind(canvas),
					duration: 700,
					easing: fabric.util.ease.easeOutQuart
				});
				break;

			case 'fail':
				canvObj.animate({
					'scaleX': 0.8,
					'scaleY': 0.8,
					'opacity': 0,
					'left': '' + -config.canvOpts.movements.radius
				}, // 'top': '-='+config.canvOpts.movements.radius
				{
					onChange: canvas.renderAll.bind(canvas),
					duration: 1000
				});
				// easing: fabric.util.ease.easeOutQuart
				break;
		}

		// Update score
		updateScore(newScore);
	}

	// ********
	// * Init *
	// ********

	config.currentMovements = [];
	config.currentScore = 0;
	config.currentStartDate = 0;

	// Get computed styles of whole page wrapper
	var canvasComputedStyleObj = getComputedStyle(document.querySelectorAll('.wr')[0]);

	// Set canvas options
	config.oneWPercent = parseInt(canvasComputedStyleObj.width.slice(0, -2)) / 100;
	config.oneHPercent = parseInt(canvasComputedStyleObj.height.slice(0, -2)) / 100;

	config.canvOpts = {
		bgURL: '../img/bg-crowd-1.jpg',
		computedStyle: {
			width: config.oneWPercent * 100,
			height: config.oneHPercent * 100
		},
		movements: {
			radius: config.oneWPercent * config.movements.radiusPercent,
			strokeWidth: config.oneWPercent * config.movements.strokeWidthPercent
		}
	};

	// Initialize 'fabric' canvas obj
	var canvas = new fabric.StaticCanvas('game', {
		width: config.canvOpts.computedStyle.width,
		height: config.canvOpts.computedStyle.height
	});

	// Draw "perfect success" place shadow circle
	config.shadowCircle = new fabric.Circle({
		fill: 'rgba(200,200,200,0.2)',
		stroke: 'rgba(200,200,200,1)',
		strokeWidth: config.canvOpts.movements.strokeWidth * 2,
		radius: config.canvOpts.movements.radius + config.canvOpts.movements.strokeWidth,
		top: Math.round(config.oneHPercent * 45),
		left: config.oneWPercent * 20
	});
	canvas.add(config.shadowCircle);

	// Set handler for adding of next movement in queue
	document.addEventListener('glAddMovement', onGlAddMovement);

	// Set handler for movement result event
	document.addEventListener('glStatus', onGlStatus);

	// Set handler for game setup event
	document.addEventListener('glSetupEvent', onGlSetupEvent);

	// Show current game code
	var codeContainer = document.getElementById('code-container');
	codeContainer.innerHTML = code;

	// *********
	// * Audio *
	// *********

	// Add muted state saving feature to Howl (audio lib)
	Howl.prototype.muted = false;
	Howl.muted = false;

	// Get volume button element
	var volumeBtn = document.querySelectorAll('.volume-btn')[0];
	// and set onClick event handler
	volumeBtn.addEventListener('click', onVolumeBtnClick);

	// Get volume level slider
	var volumeSlider = document.querySelectorAll('.volume-input')[0];
	// and set onInput event handler
	volumeSlider.addEventListener('input', onVolumeSliderInput);

	// Change canvas background size on window resize
	window.onresize = function () {
		refreshComputedSizes(canvasComputedStyleObj);
		canvas.renderAll.bind(canvas);
	};

	// TEST
	// document.addEventListener('click', closePopup);
})();
//# sourceMappingURL=data:application/json;base64,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LEtBQUssS0FBTCxDQUFXLE9BQU8sV0FBUCxHQUFtQixFQUE5QixDQUxrQztBQU12QyxRQUFNLE9BQU8sV0FBUCxHQUFxQjtBQU5ZLEVBQWxCLENBQXRCO0FBUUEsUUFBTyxHQUFQLENBQVcsT0FBTyxZQUFsQjs7O0FBR0EsVUFBUyxnQkFBVCxDQUEwQixlQUExQixFQUEyQyxlQUEzQzs7O0FBR0EsVUFBUyxnQkFBVCxDQUEwQixVQUExQixFQUFzQyxVQUF0Qzs7O0FBR0EsVUFBUyxnQkFBVCxDQUEwQixjQUExQixFQUEwQyxjQUExQzs7O0FBR0EsS0FBSSxnQkFBZ0IsU0FBUyxjQUFULENBQXdCLGdCQUF4QixDQUFwQjtBQUNBLGVBQWMsU0FBZCxHQUEwQixJQUExQjs7Ozs7OztBQVFBLE1BQUssU0FBTCxDQUFlLEtBQWYsR0FBdUIsS0FBdkI7QUFDQSxNQUFLLEtBQUwsR0FBYSxLQUFiOzs7QUFHQSxLQUFJLFlBQVksU0FBUyxnQkFBVCxDQUEwQixhQUExQixFQUF5QyxDQUF6QyxDQUFoQjs7QUFFQSxXQUFVLGdCQUFWLENBQTJCLE9BQTNCLEVBQW9DLGdCQUFwQzs7O0FBR0EsS0FBSSxlQUFlLFNBQVMsZ0JBQVQsQ0FBMEIsZUFBMUIsRUFBMkMsQ0FBM0MsQ0FBbkI7O0FBRUEsY0FBYSxnQkFBYixDQUE4QixPQUE5QixFQUF1QyxtQkFBdkM7OztBQUlBLFFBQU8sUUFBUCxHQUFrQixZQUFVO0FBQzNCLHVCQUFxQixzQkFBckI7QUFDQSxTQUFPLFNBQVAsQ0FBaUIsSUFBakIsQ0FBc0IsTUFBdEI7QUFDQSxFQUhEOzs7O0FBZ0JDLENBMVdEIiwiZmlsZSI6InJlbmRlci5qcyIsInNvdXJjZXNDb250ZW50IjpbIjtcbi8vXG4vL1x0VXRpbHNcbi8vXG4vLyAqIGFuaW1hdGUoY2IsIGR1cmF0b24pIC0tIHdyYXBwZXIgb2YgcmVxdWVzdEFuaW1hdGlvbkZyYW1lXG4vL1xuLy8gRE9NIG1hbmlwdWxhdGlvbnNcbi8vXG4vLyAqIGNsb3NlUG9wdXAoZXZlbnQpIC0tIGNsb3NlIHBvcHVwIHdpdGggdXNlcnMgdW5pcXVlIGNvZGVcbi8vICogb25Wb2x1bWVCdG5DbGljayhldmVudCkgLS0gaGFuZGxlciBmb3Igdm9sdW1lIGJ1dHRvbnMgY2xpY2tzIChtdXRlL3VubXV0ZSB0cmlnZ2VyKVxuLy8gKiBvblZvbHVtZVNsaWRlcklucHV0KGV2ZW50KSAtLSBjaGFuZ2UgYXVkaW8gdm9sdW1lIHdoZW52b2x1bWUgc2xpZGVyIGlzIGJlaW5nIG1vdmVkXG4vLyAqIHVwZGF0ZVNjb3JlKG51bWJlcikgLS0gdXBkYXRlIGN1cnJlbnQgc2NvcmVcbi8vXG4vL1x0Q2FudmFzXG4vL1xuLy8gKiByZWZyZXNoQ29tcHV0ZWRTaXplcyhvYmplY3QpIC0tIGNoYW5nZSA8Y2FudmFzPiBzaXplcyB0byBhY3R1YWxcbi8vICogYWRkTW92ZW1lbnRPbkNhbnZhcyhtb3ZlbWVudEluZm8pIC0tIGFkZCBuZXcgbW92ZW1lbnQgY2FudmFzLW9iamVjdFxuLy8gKiBhbmltYXRlTW92ZW1lbnQob2JqZWN0KSAtLSBtYWtlIHJlY2lldmVkIGFscmVhZHkgYWRkZWQgbW92ZW1lbnQgcnVuIChhbmltYXRlKVxuLy8gKiBvbkFnU2V0dXBFdmVudChldmVudCkgLS0gaGFuZGxlciBmb3IgZXZlbnQsIGZpcmVkIHdoZW4gZ2FtZSBzZXR0aW5ncyBhcmUgcmVjaWV2ZWRcbi8vXG4vLyBUbyByZW1vdmVcbi8vXG4vLyAqIHN0YXJ0KCkgLS0gc3RhcnQgZ2FtZVxuLy8gKiBuZXh0QmVhdChpc0ZpcnN0KSAtLSBwcm9jZXNzIChhbmQgYWRkKSBuZXh0IG1vdmVtZW50XG4vL1xuLy8gSW5pdGlhbGl6YXRpb25cbi8vXG5cblxuKGZ1bmN0aW9uKCl7XG5cbmZ1bmN0aW9uIGFuaW1hdGUoZHJhdywgZHVyYXRpb24pIHtcbiAgdmFyIHN0YXJ0ID0gcGVyZm9ybWFuY2Uubm93KCk7XG5cbiAgcmVxdWVzdEFuaW1hdGlvbkZyYW1lKGZ1bmN0aW9uIGFuaW1hdGUodGltZSkge1xuICAgIC8vINC+0L/RgNC10LTQtdC70LjRgtGMLCDRgdC60L7Qu9GM0LrQviDQv9GA0L7RiNC70L4g0LLRgNC10LzQtdC90Lgg0YEg0L3QsNGH0LDQu9CwINCw0L3QuNC80LDRhtC40LhcbiAgICB2YXIgdGltZVBhc3NlZCA9IHRpbWUgLSBzdGFydDtcblxuICAgIC8vINCy0L7Qt9C80L7QttC90L4g0L3QtdCx0L7Qu9GM0YjQvtC1INC/0YDQtdCy0YvRiNC10L3QuNC1INCy0YDQtdC80LXQvdC4LCDQsiDRjdGC0L7QvCDRgdC70YPRh9Cw0LUg0LfQsNGE0LjQutGB0LjRgNC+0LLQsNGC0Ywg0LrQvtC90LXRhlxuICAgIGlmICh0aW1lUGFzc2VkID4gZHVyYXRpb24pIHRpbWVQYXNzZWQgPSBkdXJhdGlvbjtcblxuICAgIC8vINC90LDRgNC40YHQvtCy0LDRgtGMINGB0L7RgdGC0L7Rj9C90LjQtSDQsNC90LjQvNCw0YbQuNC4INCyINC80L7QvNC10L3RgiB0aW1lUGFzc2VkXG4gICAgZHJhdyh0aW1lUGFzc2VkKTtcblxuICAgIC8vINC10YHQu9C4INCy0YDQtdC80Y8g0LDQvdC40LzQsNGG0LjQuCDQvdC1INC30LDQutC+0L3Rh9C40LvQvtGB0YwgLSDQt9Cw0L/Qu9Cw0L3QuNGA0L7QstCw0YLRjCDQtdGJ0ZEg0LrQsNC00YBcbiAgICBpZiAodGltZVBhc3NlZCA8IGR1cmF0aW9uKSB7XG4gICAgICByZXF1ZXN0QW5pbWF0aW9uRnJhbWUoYW5pbWF0ZSk7XG4gICAgfVxuXG4gIH0pO1xufVxuXG5cbnZhciBjb25maWcgPSB7XG5cdGNvbG9yczoge1xuXHRcdG5ldXRyYWw6ICcjRkZBNzAwJywgLy8gIzhEOTlBRSAjMTA3RTdEXG5cdFx0c3VjY2VzczogJyNDMkU4MTInLFxuXHRcdGZhaWw6ICcjQjgwQzA5J1xuXHR9LFxuXHRtb3ZlbWVudHM6IHtcblx0XHRyYWRpdXNQZXJjZW50OiA0LFxuXHRcdHN0cm9rZVdpZHRoUGVyY2VudDogMC41XG5cdH1cbn1cblxuZnVuY3Rpb24gY2xvc2VQb3B1cChldmVudCkge1xuXHRkb2N1bWVudC5xdWVyeVNlbGVjdG9yQWxsKCcucG9wdXAnKVswXS5jbGFzc0xpc3QuYWRkKCdjbG9zZWQnKTtcblx0ZG9jdW1lbnQucXVlcnlTZWxlY3RvckFsbCgnLmxvZ28nKVswXS5jbGFzc0xpc3QucmVtb3ZlKCd3aXRoLXBvcHVwJyk7XG59XG5cbi8vIE11dGVzIC8gdW5tdXRlcyBhdWRpb1xuZnVuY3Rpb24gb25Wb2x1bWVCdG5DbGljayhldmVudCkge1xuXG5cdGlmICghY29uZmlnLmN1cnJlbnRBdWRpby5tdXRlZCkge1xuXG5cdFx0Ly8gQ2hhbmdlIHZpZXdcblx0XHR0aGlzLmNoaWxkTm9kZXNbMV0uY2xhc3NMaXN0LnJlbW92ZSgnZmEtdm9sdW1lLXVwJyk7XG5cdFx0dGhpcy5jaGlsZE5vZGVzWzFdLmNsYXNzTGlzdC5hZGQoJ2ZhLXZvbHVtZS1vZmYnKTtcblxuXHRcdC8vIE11dGVcblx0XHRjb25maWcuY3VycmVudEF1ZGlvLm11dGUoKTtcblx0XHRjb25maWcuY3VycmVudEF1ZGlvLm11dGVkID0gdHJ1ZTtcblx0fSBlbHNlIHtcblxuXHRcdC8vIENoYW5nZSB2aWV3XG5cdFx0dGhpcy5jaGlsZE5vZGVzWzFdLmNsYXNzTGlzdC5yZW1vdmUoJ2ZhLXZvbHVtZS1vZmYnKTtcblx0XHR0aGlzLmNoaWxkTm9kZXNbMV0uY2xhc3NMaXN0LmFkZCgnZmEtdm9sdW1lLXVwJyk7XG5cblx0XHQvLyBVbm11dGVcblx0XHRjb25maWcuY3VycmVudEF1ZGlvLnVubXV0ZSgpO1xuXHRcdGNvbmZpZy5jdXJyZW50QXVkaW8ubXV0ZWQgPSBmYWxzZTtcblx0fVxuXG59XG5cbi8vIENoYW5nZSB2b2x1bWUgbGV2ZWwgb2YgY3VycmVudCBhdWRpb1xuZnVuY3Rpb24gb25Wb2x1bWVTbGlkZXJJbnB1dChldmVudCkge1xuXHRjb25maWcuY3VycmVudEF1ZGlvLnZvbHVtZSh0aGlzLnZhbHVlLzEwMCk7XG59XG5cbmZ1bmN0aW9uIHVwZGF0ZVNjb3JlKG5ld1Njb3JlKSB7XG5cblx0dmFyIHNjb3JlID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvckFsbCgnLnNjb3JlJylbMF07XG5cdHZhciBzY29yZU51bWJlciA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3JBbGwoJy5zY29yZS1udW1iZXInKVswXTtcblxuXHRzY29yZS5jbGFzc0xpc3QuYWRkKCd1cGRhdGUnKTtcblx0c2V0VGltZW91dCgoKT0+eyBzY29yZS5jbGFzc0xpc3QucmVtb3ZlKCd1cGRhdGUnKTsgfSwgNDAwKTtcblxuXHRjb25maWcuY3VycmVudFNjb3JlID0gcGFyc2VJbnQobmV3U2NvcmUpO1xuXHRzY29yZU51bWJlci5pbm5lckhUTUwgPSBjb25maWcuY3VycmVudFNjb3JlO1xuXG5cdHJldHVybiBjb25maWcuY3VycmVudFNjb3JlO1xuXG59XG5cbi8vICoqKioqKioqKipcbi8vICogQ0FOVkFTICpcbi8vICoqKioqKioqKipcblxuLy8gQ2hhbmdlcyBjYW52YXMgYmFja2dyb3VuZCBzaXplIHdoZW4gZmlyZWRcbmZ1bmN0aW9uIHJlZnJlc2hDb21wdXRlZFNpemVzKG9iamVjdCkge1xuXHRcblx0Y29uZmlnLmNhbnZPcHRzLmNvbXB1dGVkU3R5bGUgPSB7XG5cdFx0d2lkdGg6ICtvYmplY3Qud2lkdGguc2xpY2UoMCwtMiksXG5cdFx0aGVpZ2h0OiArb2JqZWN0LmhlaWdodC5zbGljZSgwLC0yKVxuXHR9O1xuXG5cdGNhbnZhcy5zZXREaW1lbnNpb25zKHtcblx0XHR3aWR0aDogY29uZmlnLmNhbnZPcHRzLmNvbXB1dGVkU3R5bGUud2lkdGgsXG5cdFx0aGVpZ2h0OiBjb25maWcuY2Fudk9wdHMuY29tcHV0ZWRTdHlsZS5oZWlnaHRcblx0fSk7XG5cbn1cblxuXG5mdW5jdGlvbiBhZGRNb3ZlbWVudE9uQ2FudmFzKG1vdmVtZW50SW5mbykge1xuXG5cdGlmIChtb3ZlbWVudEluZm8ubmFtZSA9PSAncGFzcycpIHJldHVybjtcblxuXHR2YXIgcmFkaXVzID0gY29uZmlnLmNhbnZPcHRzLm1vdmVtZW50cy5yYWRpdXM7XG5cdHZhciBzdHJva2VXaWR0aCA9IGNvbmZpZy5jYW52T3B0cy5tb3ZlbWVudHMuc3Ryb2tlV2lkdGg7XG5cdC8vIHZhciB4ID0gTWF0aC5yb3VuZChjb25maWcuY2Fudk9wdHMuY29tcHV0ZWRTdHlsZS53aWR0aCAtIChjb25maWcuY2Fudk9wdHMuY29tcHV0ZWRTdHlsZS53aWR0aC8xMDApKjMpIC0gcmFkaXVzKjI7XG5cdHZhciB4ID0gTWF0aC5yb3VuZChjb25maWcuY2Fudk9wdHMuY29tcHV0ZWRTdHlsZS53aWR0aCk7XG5cdHZhciB5ID0gTWF0aC5yb3VuZChjb25maWcub25lSFBlcmNlbnQgKiA0NSkgKyBjb25maWcuY2Fudk9wdHMubW92ZW1lbnRzLnN0cm9rZVdpZHRoKjEuNjtcblxuXHR2YXIgY2lyY2xlID0gbmV3IGZhYnJpYy5DaXJjbGUoe1xuXHRcdGZpbGw6IGNvbmZpZy5jb2xvcnMubmV1dHJhbCxcblx0XHRzdHJva2U6ICcjRkZGRkZGJyxcblx0XHRzdHJva2VXaWR0aDogc3Ryb2tlV2lkdGgsXG5cdFx0cmFkaXVzOiByYWRpdXMsXG5cdFx0b3JpZ2luWTogJ2NlbnRlcicsXG5cdFx0b3JpZ2luWDogJ2NlbnRlcidcblx0fSk7XG5cblx0Ly8gY29uc29sZS5sb2coLWNpcmNsZS5nZXRSYWRpdXNYKCkqMC44KTtcblx0dmFyIGFycm93O1xuXG5cdHN3aXRjaCAobW92ZW1lbnRJbmZvLm5hbWUpIHtcblx0XHRjYXNlICd1cCc6XG5cdFx0XHRhcnJvdyA9IG5ldyBmYWJyaWMuUGF0aChgXG5cdFx0XHRcdE0gJHstY2lyY2xlLmdldFJhZGl1c1goKSowLjY1fSAke2NpcmNsZS5nZXRSYWRpdXNZKCkqMC4xMX1cblx0XHRcdFx0TCAwICR7LWNpcmNsZS5nZXRSYWRpdXNZKCkqMC41NX1cblx0XHRcdFx0TCAke2NpcmNsZS5nZXRSYWRpdXNYKCkqMC42NX0gJHtjaXJjbGUuZ2V0UmFkaXVzWSgpKjAuMTF9XG5cdFx0XHRcdEwgJHtjaXJjbGUuZ2V0UmFkaXVzWCgpKjAuNX0gJHtjaXJjbGUuZ2V0UmFkaXVzWSgpKjAuMjV9XG5cdFx0XHRcdEwgMCAkey1jaXJjbGUuZ2V0UmFkaXVzWSgpKjAuMjV9XG5cdFx0XHRcdEwgJHstY2lyY2xlLmdldFJhZGl1c1goKSowLjV9ICR7Y2lyY2xlLmdldFJhZGl1c1koKSowLjI1fVxuXHRcdFx0XHR6YCwge1xuXHRcdFx0XHQvLyBmaWxsOiAnI2ZmZicsXG5cdFx0XHRcdG9yaWdpblk6ICdjZW50ZXInLFxuXHRcdFx0XHRvcmlnaW5YOiAnY2VudGVyJ1xuXHRcdFx0fSk7XG5cdFx0YnJlYWs7XG5cblx0XHRjYXNlICdkb3duJzpcblx0XHRcdGFycm93ID0gbmV3IGZhYnJpYy5QYXRoKGBcblx0XHRcdFx0TSAke2NpcmNsZS5nZXRSYWRpdXNYKCkqMC42NX0gJHstY2lyY2xlLmdldFJhZGl1c1koKSowLjExfVxuXHRcdFx0XHRMIDAgJHtjaXJjbGUuZ2V0UmFkaXVzWSgpKjAuNTV9XG5cdFx0XHRcdEwgJHstY2lyY2xlLmdldFJhZGl1c1goKSowLjY1fSAkey1jaXJjbGUuZ2V0UmFkaXVzWSgpKjAuMTF9XG5cdFx0XHRcdEwgJHstY2lyY2xlLmdldFJhZGl1c1goKSowLjV9ICR7LWNpcmNsZS5nZXRSYWRpdXNZKCkqMC4yNX1cblx0XHRcdFx0TCAwICR7Y2lyY2xlLmdldFJhZGl1c1koKSowLjI1fVxuXHRcdFx0XHRMICR7Y2lyY2xlLmdldFJhZGl1c1goKSowLjV9ICR7LWNpcmNsZS5nZXRSYWRpdXNZKCkqMC4yNX1cblx0XHRcdFx0emAsIHtcblx0XHRcdFx0Ly8gZmlsbDogJyNmZmYnLFxuXHRcdFx0XHRvcmlnaW5ZOiAnY2VudGVyJyxcblx0XHRcdFx0b3JpZ2luWDogJ2NlbnRlcidcblx0XHRcdH0pO1xuXHRcdGJyZWFrXG5cdH1cblx0XG5cblx0dmFyIG1vdmVtZW50ID0gbmV3IGZhYnJpYy5Hcm91cChbY2lyY2xlLCBhcnJvd10sIHtcblx0XHR0b3A6IHksXG5cdFx0bGVmdDogeFxuXHR9KTtcblxuXHRtb3ZlbWVudEluZm8uY2FudmFzT2JqZWN0ID0gbW92ZW1lbnQ7XG5cblx0Y2FudmFzLmFkZChtb3ZlbWVudCk7XG5cdGNhbnZhcy5yZW5kZXJBbGwoKTtcblx0Ly8gbW92ZW1lbnRJbmZvLnN0YXRlID0gJ2FkZGVkJztcbn1cblxuZnVuY3Rpb24gYW5pbWF0ZU1vdmVtZW50KG1vdmVtZW50SW5mbykge1xuXG5cdC8vIGlmIChtb3ZlbWVudEluZm8ubmFtZSA9PSAncGFzcycpIHJldHVybjtcblxuXHRtb3ZlbWVudEluZm8uY2FudmFzT2JqZWN0LmFuaW1hdGUoJ2xlZnQnLCAnJysoKGNvbmZpZy5vbmVXUGVyY2VudCAqIDIwKSArIGNvbmZpZy5jYW52T3B0cy5tb3ZlbWVudHMuc3Ryb2tlV2lkdGgqMS41KSwge1xuXHRcdG9uQ2hhbmdlOiBjYW52YXMucmVuZGVyQWxsLmJpbmQoY2FudmFzKSxcblx0XHRkdXJhdGlvbjogY29uZmlnLmN1cnJlbnRNaW5JbnRlcnZhbFxuXHR9KTtcbn1cblxuZnVuY3Rpb24gb25HbFNldHVwRXZlbnQoZXZlbnQpIHtcblx0Y29uZmlnLmN1cnJlbnRCcG0gPSBldmVudC5kZXRhaWwuYnBtO1xuXHRjb25maWcuY3VycmVudE1pbkludGVydmFsID0gNjAwMDAqNCAvIGNvbmZpZy5jdXJyZW50QnBtO1xuXHRjb25maWcuY3VycmVudFNvbmdOYW1lID0gZXZlbnQuZGV0YWlsLnNvbmc7XG5cdGNvbmZpZy5jdXJyZW50QXVkaW8gPSBldmVudC5kZXRhaWwubXVzaWM7XG5cdGNsb3NlUG9wdXAoKTtcblx0Y29uc29sZS5sb2coZXZlbnQuZGV0YWlsLmJwbSk7XG5cblx0Ly8gVGVzdFxuXHRjb25maWcuY3VycmVudEF1ZGlvLnBsYXkoKTtcbn1cblxuLy8gQWN0aW9ucyBwZXJmb3JtZWQgd2hlbiBjdXJyZW50IGdhbWUgc2V0dGluZ3MgcmVjaWV2ZWRcbmZ1bmN0aW9uIG9uR2xBZGRNb3ZlbWVudChldmVudCkge1xuXG5cdGNvbmZpZy5jdXJyZW50TW92ZW1lbnRzLnB1c2goe25hbWU6IGV2ZW50LmRldGFpbH0pO1xuXHR2YXIgdGhpc01vdmVtZW50ID0gY29uZmlnLmN1cnJlbnRNb3ZlbWVudHNbY29uZmlnLmN1cnJlbnRNb3ZlbWVudHMubGVuZ3RoLTFdO1xuXG5cdGlmICh0aGlzTW92ZW1lbnQubmFtZSA9PSAncGFzcycpIHJldHVybjtcblxuXHRhZGRNb3ZlbWVudE9uQ2FudmFzKHRoaXNNb3ZlbWVudCk7XG5cdGFuaW1hdGVNb3ZlbWVudCh0aGlzTW92ZW1lbnQpO1xuXG59XG5cbmZ1bmN0aW9uIG9uR2xTdGF0dXMoZXZlbnQpIHtcblxuXHR2YXIgc3RhdHVzID0gZXZlbnQuZGV0YWlsLnN0YXR1cztcblx0dmFyIG1vdmVtZW50SW5kZXggPSBldmVudC5kZXRhaWwuaW5kZXg7XG5cdHZhciBuZXdTY29yZSA9IGV2ZW50LmRldGFpbC5uZXdTY29yZTtcblxuXHRpZiAoY29uZmlnLmN1cnJlbnRNb3ZlbWVudHNbbW92ZW1lbnRJbmRleF0ubmFtZSA9PSAncGFzcycpIHJldHVybjtcblxuXHR2YXIgY2Fudk9iaiA9IGNvbmZpZy5jdXJyZW50TW92ZW1lbnRzW21vdmVtZW50SW5kZXhdLmNhbnZhc09iamVjdDtcblxuXHQvLyBSdW4gY2FudmFzIGFuaW1hdGlvblxuXHRjYW52T2JqLnNldCh7XG5cdFx0ZmlsbDogY29uZmlnLmNvbG9yc1tzdGF0dXNdLFxuXHRcdC8vIGNlbnRlcmVkU2NhbGluZzogdHJ1ZVxuXHR9KTtcblxuXHRzd2l0Y2ggKHN0YXR1cykge1xuXHRcdGNhc2UgJ3N1Y2Nlc3MnOlxuXHRcdFx0Y2Fudk9iai5hbmltYXRlKHtcblx0XHRcdFx0J3NjYWxlWCc6IDYsXG5cdFx0XHRcdCdzY2FsZVknOiA2LFxuXHRcdFx0XHQnb3BhY2l0eSc6IDAsXG5cdFx0XHRcdCdsZWZ0JzogJy09Jytjb25maWcuY2Fudk9wdHMubW92ZW1lbnRzLnJhZGl1cyo1LjIsXG5cdFx0XHRcdCd0b3AnOiAnLT0nK2NvbmZpZy5jYW52T3B0cy5tb3ZlbWVudHMucmFkaXVzKjUuMlxuXHRcdFx0fSwge1xuXHRcdFx0XHRvbkNoYW5nZTogY2FudmFzLnJlbmRlckFsbC5iaW5kKGNhbnZhcyksXG5cdFx0XHRcdGR1cmF0aW9uOiA3MDAsXG5cdFx0XHRcdGVhc2luZzogZmFicmljLnV0aWwuZWFzZS5lYXNlT3V0UXVhcnRcblx0XHRcdH0pO1xuXHRcdGJyZWFrO1xuXG5cdFx0Y2FzZSAnZmFpbCc6XG5cdFx0XHRjYW52T2JqLmFuaW1hdGUoe1xuXHRcdFx0XHQnc2NhbGVYJzogMC44LFxuXHRcdFx0XHQnc2NhbGVZJzogMC44LFxuXHRcdFx0XHQnb3BhY2l0eSc6IDAsXG5cdFx0XHRcdCdsZWZ0JzogJycrKC1jb25maWcuY2Fudk9wdHMubW92ZW1lbnRzLnJhZGl1cyksXG5cdFx0XHRcdC8vICd0b3AnOiAnLT0nK2NvbmZpZy5jYW52T3B0cy5tb3ZlbWVudHMucmFkaXVzXG5cdFx0XHR9LCB7XG5cdFx0XHRcdG9uQ2hhbmdlOiBjYW52YXMucmVuZGVyQWxsLmJpbmQoY2FudmFzKSxcblx0XHRcdFx0ZHVyYXRpb246IDEwMDAsXG5cdFx0XHRcdC8vIGVhc2luZzogZmFicmljLnV0aWwuZWFzZS5lYXNlT3V0UXVhcnRcblx0XHRcdH0pO1xuXHRcdGJyZWFrO1xuXHR9XG5cblx0Ly8gVXBkYXRlIHNjb3JlXG5cdHVwZGF0ZVNjb3JlKG5ld1Njb3JlKTtcdFxuXG59XG5cblxuXG5cblxuXG5cblxuLy8gKioqKioqKipcbi8vICogSW5pdCAqXG4vLyAqKioqKioqKlxuXG5jb25maWcuY3VycmVudE1vdmVtZW50cyA9IFtdO1xuY29uZmlnLmN1cnJlbnRTY29yZSA9IDA7XG5jb25maWcuY3VycmVudFN0YXJ0RGF0ZSA9IDA7XG5cblxuLy8gR2V0IGNvbXB1dGVkIHN0eWxlcyBvZiB3aG9sZSBwYWdlIHdyYXBwZXJcbnZhciBjYW52YXNDb21wdXRlZFN0eWxlT2JqID0gZ2V0Q29tcHV0ZWRTdHlsZShkb2N1bWVudC5xdWVyeVNlbGVjdG9yQWxsKCcud3InKVswXSk7XG5cbi8vIFNldCBjYW52YXMgb3B0aW9uc1xuY29uZmlnLm9uZVdQZXJjZW50ID0gcGFyc2VJbnQoY2FudmFzQ29tcHV0ZWRTdHlsZU9iai53aWR0aC5zbGljZSgwLC0yKSkvMTAwO1xuY29uZmlnLm9uZUhQZXJjZW50ID0gcGFyc2VJbnQoY2FudmFzQ29tcHV0ZWRTdHlsZU9iai5oZWlnaHQuc2xpY2UoMCwtMikpLzEwMDtcblxuY29uZmlnLmNhbnZPcHRzID0ge1xuXHRiZ1VSTDogJy4uL2ltZy9iZy1jcm93ZC0xLmpwZycsXG5cdGNvbXB1dGVkU3R5bGU6IHtcblx0XHR3aWR0aDogY29uZmlnLm9uZVdQZXJjZW50KjEwMCxcblx0XHRoZWlnaHQ6IGNvbmZpZy5vbmVIUGVyY2VudCoxMDBcblx0fSxcblx0bW92ZW1lbnRzOiB7XG5cdFx0cmFkaXVzOiBjb25maWcub25lV1BlcmNlbnQgKiBjb25maWcubW92ZW1lbnRzLnJhZGl1c1BlcmNlbnQsXG5cdFx0c3Ryb2tlV2lkdGg6IGNvbmZpZy5vbmVXUGVyY2VudCAqIGNvbmZpZy5tb3ZlbWVudHMuc3Ryb2tlV2lkdGhQZXJjZW50XG5cdH1cbn1cblxuXG4vLyBJbml0aWFsaXplICdmYWJyaWMnIGNhbnZhcyBvYmpcbnZhciBjYW52YXMgPSBuZXcgZmFicmljLlN0YXRpY0NhbnZhcygnZ2FtZScsIHtcblx0d2lkdGg6IGNvbmZpZy5jYW52T3B0cy5jb21wdXRlZFN0eWxlLndpZHRoLFxuXHRoZWlnaHQ6IGNvbmZpZy5jYW52T3B0cy5jb21wdXRlZFN0eWxlLmhlaWdodCxcbn0pO1xuXG4vLyBEcmF3IFwicGVyZmVjdCBzdWNjZXNzXCIgcGxhY2Ugc2hhZG93IGNpcmNsZVxuY29uZmlnLnNoYWRvd0NpcmNsZSA9IG5ldyBmYWJyaWMuQ2lyY2xlKHtcblx0ZmlsbDogJ3JnYmEoMjAwLDIwMCwyMDAsMC4yKScsXG5cdHN0cm9rZTogJ3JnYmEoMjAwLDIwMCwyMDAsMSknLFxuXHRzdHJva2VXaWR0aDogY29uZmlnLmNhbnZPcHRzLm1vdmVtZW50cy5zdHJva2VXaWR0aCoyLFxuXHRyYWRpdXM6IGNvbmZpZy5jYW52T3B0cy5tb3ZlbWVudHMucmFkaXVzICsgY29uZmlnLmNhbnZPcHRzLm1vdmVtZW50cy5zdHJva2VXaWR0aCxcblx0dG9wOiBNYXRoLnJvdW5kKGNvbmZpZy5vbmVIUGVyY2VudCo0NSksXG5cdGxlZnQ6IGNvbmZpZy5vbmVXUGVyY2VudCAqIDIwXG59KVxuY2FudmFzLmFkZChjb25maWcuc2hhZG93Q2lyY2xlKTtcblxuLy8gU2V0IGhhbmRsZXIgZm9yIGFkZGluZyBvZiBuZXh0IG1vdmVtZW50IGluIHF1ZXVlXG5kb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKCdnbEFkZE1vdmVtZW50Jywgb25HbEFkZE1vdmVtZW50KTtcblxuLy8gU2V0IGhhbmRsZXIgZm9yIG1vdmVtZW50IHJlc3VsdCBldmVudFxuZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lcignZ2xTdGF0dXMnLCBvbkdsU3RhdHVzKTtcblxuLy8gU2V0IGhhbmRsZXIgZm9yIGdhbWUgc2V0dXAgZXZlbnRcbmRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoJ2dsU2V0dXBFdmVudCcsIG9uR2xTZXR1cEV2ZW50KTtcblxuLy8gU2hvdyBjdXJyZW50IGdhbWUgY29kZVxudmFyIGNvZGVDb250YWluZXIgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnY29kZS1jb250YWluZXInKTtcbmNvZGVDb250YWluZXIuaW5uZXJIVE1MID0gY29kZTtcblxuXG4vLyAqKioqKioqKipcbi8vICogQXVkaW8gKlxuLy8gKioqKioqKioqXG5cbi8vIEFkZCBtdXRlZCBzdGF0ZSBzYXZpbmcgZmVhdHVyZSB0byBIb3dsIChhdWRpbyBsaWIpXG5Ib3dsLnByb3RvdHlwZS5tdXRlZCA9IGZhbHNlO1xuSG93bC5tdXRlZCA9IGZhbHNlO1xuXG4vLyBHZXQgdm9sdW1lIGJ1dHRvbiBlbGVtZW50XG52YXIgdm9sdW1lQnRuID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvckFsbCgnLnZvbHVtZS1idG4nKVswXTtcbi8vIGFuZCBzZXQgb25DbGljayBldmVudCBoYW5kbGVyXG52b2x1bWVCdG4uYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCBvblZvbHVtZUJ0bkNsaWNrKTtcblxuLy8gR2V0IHZvbHVtZSBsZXZlbCBzbGlkZXJcbnZhciB2b2x1bWVTbGlkZXIgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yQWxsKCcudm9sdW1lLWlucHV0JylbMF07XG4vLyBhbmQgc2V0IG9uSW5wdXQgZXZlbnQgaGFuZGxlclxudm9sdW1lU2xpZGVyLmFkZEV2ZW50TGlzdGVuZXIoJ2lucHV0Jywgb25Wb2x1bWVTbGlkZXJJbnB1dClcblxuXG4vLyBDaGFuZ2UgY2FudmFzIGJhY2tncm91bmQgc2l6ZSBvbiB3aW5kb3cgcmVzaXplXG53aW5kb3cub25yZXNpemUgPSBmdW5jdGlvbigpe1xuXHRyZWZyZXNoQ29tcHV0ZWRTaXplcyhjYW52YXNDb21wdXRlZFN0eWxlT2JqKTtcblx0Y2FudmFzLnJlbmRlckFsbC5iaW5kKGNhbnZhcyk7XG59XG5cblxuXG5cblxuXG5cblxuXG4vLyBURVNUXG4vLyBkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsIGNsb3NlUG9wdXApO1xuXG59KSgpOyJdLCJzb3VyY2VSb290IjoiL3NvdXJjZS8ifQ==
